#!/bin/bash

# Author: Daniel Kahn Gillmor <dkg@fifthhorseman.net>
# Date: 2009-10-08
# License: GPL v3+

set -e

# depends on grub2

# specify the first argument as the new installer image:

output="$1"

SUITE=${SUITE:-stable}
ARCH=${ARCH:-amd64}
DISTRO=${DISTRO:-debian}

if [ -z "$output" ] ; then
    printf "you must specify a file name for the image to be built" >&2
    exit 1
fi

if [ -e "$output" ] ; then
    printf "file '%s' already exists" "$output" >&2
    exit 1
fi


WORKDIR=$(mktemp -d)

cleanup() {
    rm -rf "$WORKDIR"
}

trap cleanup EXIT

case "$DISTRO" in
    debian)
        BASEPATH="http://ftp.nl.debian.org/debian/dists/$SUITE/main/installer-$ARCH/current/images/netboot/debian-installer/$ARCH"
        ;;
    ubuntu)
        BASEPATH="http://archive.ubuntu.com/ubuntu/dists/$SUITE/main/installer-$ARCH/current/images/netboot/ubuntu-installer/$ARCH"
        ;;
esac

( cd "$WORKDIR" && wget "$BASEPATH"/{linux,initrd.gz} )

mkdir -p "$WORKDIR/boot/grub"

cat > "$WORKDIR/boot/grub/grub.cfg" <<EOF
serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1
terminal_output serial
terminal_input serial

menuentry "$SUITE d-i (created $(date -R))" {
  linux /linux verbose -- console=ttyS0,115200n8
  initrd /initrd.gz
}
EOF

absoutput="$(pwd)/$output"

## no longer using genisoimage with grub2:
# genisoimage -R -input-charset utf-8 -b boot/grub/stage2_eltorito -no-emul-boot --boot-load-size 4 -boot-info-table "$WORKDIR"

(cd "$WORKDIR" && grub-mkrescue --output="$absoutput" .)
